<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plani üåé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicons by system scheme (fallback) -->
  <link rel="icon" href="logo-claro.ico"  media="(prefers-color-scheme: light)">
  <link rel="icon" href="logo-oscuro.ico" media="(prefers-color-scheme: dark)">
  <!-- Dynamic favicon that follows our theme toggle -->
  <link id="dyn-favicon" rel="icon" href="logo-claro.ico">
  <script>
    const isProd = window.location.hostname === 'plani.vercel.app';
    const imgBase = isProd ? 'https://plani.vercel.app/' : '';
    document.querySelectorAll('link[rel="icon"]').forEach(link => {
      link.href = imgBase + link.href;
    });
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Geocoder (optional CSS) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <!-- Chart.js (single load) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter','SF Pro Display',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; }
    html, body { height:100%; }
    body {
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.85) 0, rgba(255,255,255,0) 45%),
                  radial-gradient(circle at 80% 10%, rgba(196,210,255,0.45) 0, rgba(196,210,255,0) 55%),
                  linear-gradient(160deg, #f5f7fa 0%, #eef2ff 40%, #ffffff 100%);
      color:#0f172a; min-height:100vh; overflow:hidden;
    }
    #container { position:relative; width:100%; height:100vh; padding:24px; }
    #map {
      position:absolute; inset:24px;
      z-index:0; border-radius:28px; overflow:hidden;
      box-shadow:0 35px 70px rgba(15,23,42,0.18);
      cursor:crosshair; background:#e5eefb;
    }
    #sidebar {
      position:absolute; top:36px; right:36px;
      width:min(480px,calc(100vw - 72px));
      max-height:calc(100vh - 72px);
      background:rgba(248,250,255,0.9);
      display:flex; flex-direction:column;
      border-radius:26px; backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.55);
      box-shadow:0 45px 90px rgba(15,23,42,0.2);
      overflow:hidden; z-index:10;
      transition: transform .25s ease, opacity .25s ease, box-shadow .25s ease;
    }
    #sidebar.collapsed{ transform: translateX(calc(100% + 24px)); opacity: 0; box-shadow: none; pointer-events: none; }
    #sidebar h1 {
      padding:22px 26px 16px; font-size:22px; font-weight:700;
      background:rgba(236,243,255,0.72);
      position:sticky; top:0; z-index:1;
      border-bottom:1px solid rgba(210,224,249,0.65);
      letter-spacing:-0.01em;
    }
    #content { display:flex; flex-direction:column; gap:14px; padding-bottom:18px; overflow-y:auto; min-height:0; }
    .card { margin:0 26px; background:rgba(255,255,255,0.86); border-radius:20px; padding:16px 18px; box-shadow:0 24px 54px rgba(148,163,184,0.2); border:1px solid rgba(226,232,240,0.75); position:relative; }
    .card h3 { margin-bottom:12px; font-size:16px; font-weight:600; color:#0f172a; }
  .muted { color:#64748b; font-size:13px; }
    .status-summary-heading{
      margin-top:12px;
      font-size:14px;
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
      color:rgba(255,255,255,0.72);
    }
    .status-summary-body{
      font-size:14px;
      color:rgba(255,255,255,0.92);
      line-height:1.55;
      margin-top:6px;
    }
    .status-summary-body.muted{ color:rgba(255,255,255,0.6); }
    .status-summary-body .summary-brief { font-size:14px; color:rgba(255,255,255,0.92); line-height:1.5; margin-bottom:10px; }
    .status-summary-body .summary-breakdown { list-style-position: inside; margin:0; padding-left:0; font-size:14px; color:rgba(255,255,255,0.86); }
    .status-summary-body .summary-breakdown li { margin-bottom:4px; }
    .status-summary-message{ font-size:14px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; padding:0; align-items:flex-start; }
    .row > * { flex:1; min-width:130px; }
    label { font-size:14px; font-weight:600; color:#1f2937; display:block; margin-bottom:6px; }
    input[type="range"], input[type="date"], select { width:100%; }
    input[type="date"], select {
      padding:12px 16px; border-radius:16px; border:1px solid rgba(148,163,184,0.35);
      background:#fff; color:#0f172a; transition:border 0.2s ease, box-shadow 0.2s ease;
    }
    input[type="date"]:focus, select:focus { border-color:rgba(99,102,241,0.55); box-shadow:0 0 0 4px rgba(99,102,241,0.12); outline:none; }
    #weeks{ margin-top:4px; }
    #controls .button-group { margin-top:12px; }
    #zoneHint { margin-top:10px; }

    .button-group { display:flex; gap:10px; flex-wrap:wrap; }
    button {
      padding:12px 16px; border:none; border-radius:16px;
      background:linear-gradient(135deg,#0ea5e9 0%,#38bdf8 50%,#6366f1 100%);
      color:#fff; font-weight:600; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow:0 18px 32px rgba(99,102,241,0.22);
    }
    button:hover { transform:translateY(-1px); box-shadow:0 24px 38px rgba(37,99,235,0.18); }
    .chart-wrap { height:clamp(220px,34vh,320px); }
    canvas { width:100%!important; height:100%!important; display:block; }
    .badge { font-size:12px; font-weight:700; padding:4px 10px; border-radius:999px; }
    .ok { background:#dcfce7; color:#166534; border:1px solid #86efac; }
    .avoid { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .pill { display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(226,232,240,0.9); margin-right:6px; background:#fff; color:#334155; }
    .rec-grid { display:grid; grid-template-columns:1fr; gap:10px; }
    .rec { display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border-radius:14px; border:1px solid rgba(226,232,240,0.9); background:#fff; }
    .rec h4 { margin:0; font-size:14px; }
    .rec p { margin:2px 0 0; color:#475569; font-size:13px; }
    .status-card {
      margin:0 26px;
      border-radius:22px;
      padding:22px 24px 24px 24px;
      background:linear-gradient(135deg,#64748b 0%,#334155 100%);
      color:#fff;
      box-shadow:0 28px 52px rgba(15,23,42,0.24);
      border:1px solid rgba(255,255,255,0.16);
      display:flex; flex-direction:column; gap:12px;
      position:relative;
      overflow:visible;
    }
    .status-card.loading h2,
    .status-card.loading .status-text,
    .status-card.loading .status-summary-heading,
    .status-card.loading .status-summary-body {
      opacity:0.6;
    }
    .status-card h2 {
      font-size:18px; font-weight:700; margin:0;
      letter-spacing:-0.01em;
      line-height:1.3;
    }
    .status-card .status-text {
      margin:0;
      font-size:14px; line-height:1.6;
      color:rgba(255,255,255,0.92);
    }
    .status-chip {
      align-self:flex-start;
      font-size:12px; font-weight:700;
      padding:4px 12px;
      border-radius:999px;
      background:rgba(255,255,255,0.18);
      color:#fff;
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .status-card[data-tone="neutral"]{
      background:linear-gradient(135deg,#94a3b8 0%,#475569 100%);
    }
    .status-card[data-tone="rainy"]{
      background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 100%);
    }
    .status-card[data-tone="hot"]{
      background:linear-gradient(135deg,#f97316 0%,#dc2626 100%);
    }
    .status-card[data-tone="cold"]{
      background:linear-gradient(135deg,#60a5fa 0%,#1e40af 100%);
    }
    .status-card[data-tone="windy"]{
      background:linear-gradient(135deg,#14b8a6 0%,#0f766e 100%);
    }
    .status-card[data-tone="sunny"]{
      background:linear-gradient(135deg,#facc15 0%,#f97316 100%);
      color:#1f2937;
      border-color:rgba(148,163,184,0.25);
    }
    .status-card[data-tone="sunny"] .status-text{
      color:#334155;
    }
    .status-card[data-tone="sunny"] .status-summary-heading{
      color:#1f2937;
    }
    .status-card[data-tone="sunny"] .status-summary-body{
      color:#1f2937;
    }
    .status-card[data-tone="sunny"] .status-summary-body .summary-brief,
    .status-card[data-tone="sunny"] .status-summary-body .summary-breakdown{
      color:#1f2937;
    }
    .status-card[data-tone="sunny"] .status-summary-body.muted{
      color:#475569;
    }
    .status-card[data-tone="alert"]{
      background:linear-gradient(135deg,#f87171 0%,#b91c1c 100%);
    }
    .skeleton { position:absolute; inset:0; background:linear-gradient(90deg,rgba(0,0,0,0.02) 0,rgba(0,0,0,0.06) 50%,rgba(0,0,0,0.02) 100%); background-size:200% 100%; animation:shimmer 1.1s infinite; border-radius:inherit; display:none; }
    .loading .skeleton { display:block; }
    @keyframes shimmer { 0% { background-position:0 0; } 100% { background-position:-200% 0; } }
    #footer { padding:14px 26px 18px; font-size:12px; color:#64748b; background:rgba(236,243,255,0.78); border-top:1px solid rgba(226,232,240,0.65); }
    @media(max-width:900px){#sidebar{width:min(400px,calc(100vw - 56px));}}
    @media(max-width:768px){
      body{overflow:auto;}
      #container{padding:12px; height:auto; min-height:100vh;}
      #map{position:relative; inset:0; height:60vh; border-radius:24px;}
      #sidebar{position:relative; top:-40px; right:auto; width:min(560px,100%); max-height:none;}
    }

    /* FAB panel */
    #toggleSidebar{
      position: fixed; right: 24px; bottom: 24px; width: 48px; height: 48px;
      border-radius: 999px; display: grid; place-items: center; font-size: 20px; z-index: 10000; padding: 0;
      background: linear-gradient(135deg,#0ea5e9 0%,#38bdf8 50%,#6366f1 100%); color:#fff; border:none;
      box-shadow: 0 18px 32px rgba(99,102,241,0.28); transition: transform .2s ease, box-shadow .2s ease;
    }
    #toggleSidebar:hover{ transform: translateY(-1px); box-shadow: 0 24px 38px rgba(37,99,235,.25); }

  /* Search dock (floating corner) */
    #searchDock{
      position: fixed;
      top: calc(env(safe-area-inset-top, 0px) + 36px);
      left: calc(env(safe-area-inset-left, 0px) + 36px);
      z-index: 12000;
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      border: 1px solid rgba(226,232,240,0.9); box-shadow: 0 20px 48px rgba(15,23,42,0.18);
      border-radius: 16px; padding: 8px 10px;
    }
    #searchDock input{
      width: 280px; max-width: 44vw; border: none; outline: none; background: transparent; color:#0f172a; font-size: 14px; padding: 6px 4px;
    }
    #searchDock button{
      border: none; border-radius: 12px; padding: 8px 10px;
      background: linear-gradient(135deg,#0ea5e9 0%,#38bdf8 50%,#6366f1 100%); color: #fff; font-weight: 700; cursor: pointer;
      box-shadow: 0 12px 24px rgba(99,102,241,0.22);
    }
    #searchDock button:hover{ transform: translateY(-1px); box-shadow: 0 18px 32px rgba(99,102,241,0.26); }
    #searchDock.busy{ opacity: .85; }
    #searchDock.error{ animation: shake .28s linear 1; border-color: #ef4444; }
    @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }

    /* Chatbot */
    #chatbot-btn {
      position: fixed; bottom: 16px; left: 16px; width: 60px; height: 60px; border-radius: 50%;
      background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 50%, #6366f1 100%); color:#fff; border:none; cursor:pointer;
      box-shadow: 0 12px 25px rgba(99,102,241,0.25); display:flex; align-items:center; justify-content:center;
      font-size:26px; z-index:9999; transition: transform .2s ease, box-shadow .2s ease;
    }
    #chatbot-btn:hover { transform: scale(1.05); box-shadow: 0 18px 35px rgba(99,102,241,0.35); }
    #chatbot-window {
      position: fixed; bottom: 100px; left: 16px; width: 360px; max-height: 520px;
      background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 30px 80px rgba(15,23,42,0.25);
      border: 1px solid rgba(226,232,240,0.8); overflow: hidden; backdrop-filter: blur(12px);
      display: none; flex-direction: column; z-index: 9998;
    }
    #chatbot-header { background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 100%); color:white; padding:14px 18px; font-weight:600; font-size:15px; display:flex; justify-content:space-between; align-items:center; }
    #chatbot-body { padding:14px; overflow-y:auto; flex:1; color:#1e293b; font-size:14px; }
    #chatbot-input { display:flex; border-top:1px solid rgba(226,232,240,0.8); }
    #chatbot-input input { flex:1; border:none; padding:12px 14px; outline:none; font-size:14px; border-radius:0; }
    #chatbot-input button { border:none; background:#6366f1; color:white; padding:12px 18px; cursor:pointer; font-weight:600; border-radius:0; }
    #chatbot-input button:hover { background:#4f46e5; }

  /* Toast notifications */
    #toast{
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%) translateY(8px);
      background:#0f172acc; color:#fff; padding:10px 14px; border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.25); font-size:13px; z-index:99999;
      opacity:0; transition:opacity .25s, transform .25s;
    }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

  /* Data modal */
    #dataModalOverlay{
      position:fixed; inset:0; padding:24px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(15,23,42,0.65);
      backdrop-filter:blur(10px);
      opacity:0; pointer-events:none;
      transition:opacity .28s ease;
      z-index:150000;
    }
    #dataModalOverlay.show{ opacity:1; pointer-events:auto; }
    #dataModal{
      width:min(720px, 100%);
      background:rgba(255,255,255,0.98);
      border-radius:24px;
      box-shadow:0 32px 90px rgba(15,23,42,0.32);
      border:1px solid rgba(226,232,240,0.9);
      padding:32px;
      position:relative;
      display:flex; flex-direction:column; gap:18px;
    }
    #dataModal h2{ font-size:22px; font-weight:700; color:#0f172a; margin-bottom:4px; }
    #dataModal p{ font-size:14px; line-height:1.55; color:#475569; }
    #dataModalClose{
      position:absolute; top:18px; right:18px;
      border:none; background:transparent; font-size:22px; color:#475569;
      cursor:pointer; padding:6px; border-radius:12px;
      transition:background .2s ease, color .2s ease;
    }
    #dataModalClose:hover{ background:rgba(148,163,184,0.16); color:#1f2937; }
    #dataModalActions{ margin-top:12px; display:flex; justify-content:flex-end; }
    #dataModalActions button{
      padding:12px 20px; border-radius:16px; font-size:14px;
      background:linear-gradient(135deg,#0ea5e9 0%,#38bdf8 50%,#6366f1 100%);
      color:#fff; border:none; font-weight:600; cursor:pointer;
      box-shadow:0 18px 32px rgba(99,102,241,0.22);
      transition:transform .2s ease, box-shadow .2s ease;
    }
    #dataModalActions button:hover{ transform:translateY(-1px); box-shadow:0 24px 38px rgba(37,99,235,0.2); }
    @media(max-width:520px){
      #dataModal{ padding:24px 20px; border-radius:20px; }
      #dataModal h2{ font-size:20px; }
      #dataModalActions{ justify-content:center; }
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="map"></div>

    <div id="sidebar">
      <h1>Plani üåé</h1>
      <div id="content">
        <div id="controls" class="card">
          <h3>Area & Lead Time</h3>
          <div class="row">
            <div>
              <label>Zone radius (km)</label>
              <input id="radiusKm" type="range" min="2" max="50" step="1" value="15" />
              <div class="muted"><span id="radiusLabel">15</span> km around the point</div>
            </div>
            <div>
              <label>Start date</label>
              <input id="startDate" type="date" />
            </div>
            <div>
              <label>Weeks</label>
              <select id="weeks">
                <option value="1" selected>1 week</option>
                <option value="3">3 weeks</option>
                <option value="2">2 weeks</option>
                <option value="4">4 weeks</option>
              </select>
            </div>
          </div>
          <div class="button-group">
            <button id="btnForecast">Forecast area</button>
          </div>
          <div class="muted" id="zoneHint">Click on the map (or search for a city) to choose the center, then adjust the radius and start date.</div>
        </div>

        <div id="statusCard" class="status-card" data-tone="neutral" style="display:none;">
          <div class="skeleton"></div>
          <h2 id="statusTitle"></h2>
          <p class="status-text" id="statusText"></p>
          <div class="status-summary-heading">Area summary</div>
          <div id="statusSummaryBody" class="status-summary-body muted">No data yet. Request a forecast.</div>
        </div>

        <div id="recsCard" class="card">
          <div class="skeleton"></div>
          <h3>Recommendations</h3>
          <div id="recs" class="rec-grid">
            <div class="muted">We'll tell you what to do or avoid based on wind, rain, heat, cold, and snow.</div>
          </div>
        </div>

        <div class="card" style="text-align:center;">
          <h3>Base map</h3>
          <div class="button-group" style="justify-content:center;">
            <button id="btnMapOSM">Political (OSM)</button>
            <button id="btnMapEsri">World Imagery (Esri)</button>
          </div>
        </div>
      </div>
      <div id="footer">Powered by NASA</div>
    </div>
  </div>

  <!-- Floating search dock (separate corner) -->
  <div id="searchDock" role="search" aria-label="Search location">
    <input id="searchInput" type="text" placeholder="Search location..." />
    <button id="searchGo" title="Search">üîé</button>
  </div>

  <!-- Floating button: toggle panel -->
  <button id="toggleSidebar" aria-label="Hide panel" title="Hide panel">¬´</button>

  <!-- Floating chatbot button -->
  <button id="chatbot-btn">üí¨</button>
  <div id="chatbot-window">
    <div id="chatbot-header">
      Assistant Chat
      <span id="chatbot-close" style="cursor:pointer;font-weight:bold;">√ó</span>
    </div>
    <div id="chatbot-body">
      <p><strong>Bot:</strong> Hi there! How can I help you today?</p>
    </div>
    <div id="chatbot-input">
      <input type="text" id="chatbot-text" placeholder="Type your message..." />
      <button id="chatbot-send">Send</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Data sources modal -->
  <div id="dataModalOverlay" role="dialog" aria-modal="true" aria-labelledby="dataModalTitle">
    <div id="dataModal">
      <button id="dataModalClose" aria-label="Close notice">√ó</button>
      <div>
        <h2 id="dataModalTitle">Data sources and methodology</h2>
        <p>
          This project relies on historical climate records from the NASA POWER platform, an internationally trusted source with high accuracy and global coverage. We focus on observations collected between 2000 and 2024 to build a solid, representative baseline for the study region.
        </p>
        <p>
          On top of that dataset we apply advanced analytics assisted by artificial intelligence, using language and prediction models developed by OpenAI. This collaboration helps us explore climate patterns, seasonal trends, and key anomalies to generate well-founded projections for the expected conditions in 2025 and 2026.
        </p>
        <p>
          For validation, we compare the projections generated for 2025 against the actual observed data for that year. This comparison lets us refine the model parameters and improve confidence in the forecasts ahead. The approach blends the robustness of NASA satellite data with AI-driven modeling.
        </p>
        <p>
          Temperature descriptions are categorized based on Celsius thresholds: 'Very hot' for 32¬∞C and above, 'Hotter' for 28-31¬∞C, 'Warm' for 22-27¬∞C, 'Mild' for 16-21¬∞C, 'Cool' for 8-15¬∞C, 'Cold' for 0-7¬∞C, and 'Freezing' for below 0¬∞C. This classification helps provide intuitive insights into thermal conditions.
        </p>
      </div>
      <div id="dataModalActions">
        <button id="dataModalAck" type="button">Got it</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>



  <script>

    // Environment config
    const isProduction = window.location.hostname === 'plani.vercel.app';
    const BASE_URL = isProduction ? 'https://plani.vercel.app' : 'http://localhost:5000';
    const IMAGE_BASE = isProduction ? 'https://plani.vercel.app/' : '';

    (function(){
      const dyn = document.getElementById('dyn-favicon');
      function setFav(mode){ dyn.href = mode === 'dark' ? IMAGE_BASE + 'logo-oscuro.ico' : IMAGE_BASE + 'logo-claro.ico'; }
      const mql = window.matchMedia('(prefers-color-scheme: dark)');
      setFav(mql.matches ? 'dark' : 'light');
      // Actualiza si el usuario cambia el tema del SO con la pesta√±a abierta
      if (mql.addEventListener) {
        mql.addEventListener('change', e => setFav(e.matches ? 'dark' : 'light'));
      } else if (mql.addListener) { // Safari viejo
        mql.addListener(e => setFav(e.matches ? 'dark' : 'light'));
      }
    })();
  </script>

  <script>
  /************ MAP ************/
    const WORLD_BOUNDS = L.latLngBounds([-85, -180], [85, 180]);
    const map = L.map('map', {
      minZoom:2, maxZoom:19,
      maxBounds:WORLD_BOUNDS, maxBoundsViscosity:1.0,
      worldCopyJump:false, zoomControl:true
    }).setView([-41.13, -71.31], 5);

    /* ===================== RECOMMENDATIONS ===================== */
    function getSeason(dateISO, lat){
      const d = new Date(dateISO);
      const m = d.getUTCMonth() + 1; // 1..12
      const north = lat >= 0;
      const seasonNorth = (m<=2||m===12)?'winter':(m<=5)?'spring':(m<=8)?'summer':'autumn';
      const seasonSouth = (m<=2||m===12)?'summer':(m<=5)?'autumn':(m<=8)?'winter':'spring';
      return north ? seasonNorth : seasonSouth;
    }
    function nz(v, def=0){ return (v===null || v===undefined || Number.isNaN(v)) ? def : Number(v); }
    function asNumber(v){
      if(v===null || v===undefined) return null;
      const n = Number(v);
      return Number.isNaN(n) ? null : n;
    }
    function renderRecs(list){
      const recsEl = document.getElementById('recs');
      if(!recsEl) return;
      if(!list.length){
        recsEl.innerHTML = `<div class="muted">Not enough recommendations with the available data.</div>`;
        return;
      }
      recsEl.innerHTML = list.map(r => `
        <div class="rec">
          <div style="font-size:18px;line-height:1.2">${r.emoji||'üß≠'}</div>
          <div>
            <h4>${r.title} ${r.status==='ok'
              ? '<span class="badge ok">Recommended</span>'
              : '<span class="badge avoid">Avoid</span>'}</h4>
            <p>${r.detail}</p>
            ${r.tags?.length? r.tags.map(t=>`<span class="pill">${t}</span>`).join(''):''}
          </div>
        </div>
      `).join('');
    }
    function buildRecommendations({lat, dateISO, temperature, rain, windSpeed, radiation}){
      const T = nz(temperature);
      const P = nz(rain);
      const W = nz(windSpeed);
      const R = nz(radiation);
      const season = getSeason(dateISO, lat);

      const hot = T >= 26, warm = T >= 18 && T < 26, cool = T >= 10 && T < 18, cold = T < 10;
      const heavyRain = P >= 10, rainMod = P >= 2 && P < 10;
      const breezy = W >= 4 && W < 8, windy = W >= 8 && W < 14, veryWindy = W >= 14;
      const highRad = R >= 650;

      const recs = [];

      // BEACH
      if(hot && !rainMod && W < 12){
        recs.push({
          title:'Beach & water',
          emoji:'üèñÔ∏è',
          status:'ok',
          detail:`Hot ${T.toFixed(0)}¬∞C, minimal rain (${P.toFixed(1)} mm) and wind ${W.toFixed(1)} m/s. ${highRad?'Use strong sunscreen (high radiation).':''}`,
          tags:['Sunshade', highRad?'SPF 50+':'SPF', season]
        });
      } else {
        recs.push({
          title:'Beach',
          emoji:'üèùÔ∏è',
          status:'avoid',
          detail:`Conditions are not ideal: T=${T.toFixed(0)}¬∞C, P=${P.toFixed(1)} mm, W=${W.toFixed(1)} m/s.`,
          tags:[season]
        });
      }

      // HIKING / WALKING
      if((warm || cool) && P<5 && W<10){
        recs.push({
          title:'Hiking / Walking',
          emoji:'ü•æ',
          status:'ok',
          detail:`Comfortable weather for moderate activity (T=${T.toFixed(0)}¬∞C, rain ${P.toFixed(1)} mm, wind ${W.toFixed(1)} m/s).`,
          tags:[season, breezy?'Breeze':'Calm']
        });
      } else {
        recs.push({
          title:'Hiking',
          emoji:'üö∂‚Äç‚ôÇÔ∏è',
          status:'avoid',
          detail:`Weather may feel uncomfortable (T=${T.toFixed(0)}¬∞C, P=${P.toFixed(1)} mm, W=${W.toFixed(1)} m/s).`,
          tags:[rainMod||heavyRain?'Muddy':'Exposure', season]
        });
      }

      // CYCLING
      if((warm || cool) && P<3 && W<8){
        recs.push({
          title:'Cycling',
          emoji:'üö¥',
          status:'ok',
          detail:`Little rain and light wind: great for a ride.`,
          tags:[season, 'Light wind']
        });
      } else {
        recs.push({
          title:'Cycling',
          emoji:'üö≤',
          status:'avoid',
          detail:`Wind or precipitation may make it risky (P=${P.toFixed(1)} mm, W=${W.toFixed(1)} m/s).`,
          tags:[veryWindy?'Gusty':'Wet']
        });
      }

      // WIND SPORTS
      if(windy && P<3){
        recs.push({
          title:'Kitesurf / Windsurf',
          emoji:'ü™Å',
          status:'ok',
          detail:`Usable wind (${W.toFixed(1)} m/s) and low precipitation.`,
          tags:['Wind', season]
        });
      } else if(veryWindy){
        recs.push({
          title:'Wind sports',
          emoji:'üå¨Ô∏è',
          status:'avoid',
          detail:`Wind is excessive (${W.toFixed(1)} m/s). Wait for steadier conditions.`,
          tags:['Gusty']
        });
      }

      // SNOW / SKI
      const snowish = T <= 2 && P >= 1;
      if(snowish){
        recs.push({
          title:'Ski / Snow',
          emoji:'üéø',
          status:'ok',
          detail:`Cold with precipitation suggests wintry conditions (T=${T.toFixed(0)}¬∞C, P=${P.toFixed(1)} mm). Check local snow reports.`,
          tags:[season, 'Warm layers']
        });
      } else if(cold && P<1){
        recs.push({
          title:'Snow',
          emoji:'üßä',
          status:'avoid',
          detail:`It is cold but lacks precipitation for usable snow (T=${T.toFixed(0)}¬∞C).`,
          tags:[season]
        });
      }

      // INDOOR PLAN
      if(heavyRain){
        recs.push({
          title:'Indoor plan (museums, cafes, cinema)',
          emoji:'üèõÔ∏è',
          status:'ok',
          detail:`Significant rain (${P.toFixed(1)} mm). Consider indoor activities.`,
          tags:['Dry', season]
        });
      }

      // PICNIC / PARK
      if((warm || cool) && P<2 && W<6 && !highRad){
        recs.push({
          title:'Picnic / Park',
          emoji:'üß∫',
          status:'ok',
          detail:`Pleasant weather and moderate radiation.`,
          tags:[season, 'Light shade']
        });
      }

      // PHOTOGRAPHY
      if(highRad && P===0){
        recs.push({
          title:'Daytime photography',
          emoji:'üì∏',
          status:'ok',
          detail:`Very clear sky (radiation ~${R.toFixed(0)} W/m¬≤). Excellent visibility.`,
          tags:['Clear sky', season]
        });
      }

      const score = r=>{
        let s = 0;
        if(r.status==='ok') s+=10;
        if(r.title.includes('Beach') && hot) s+=2;
        if(r.title.includes('Hiking') && (cool||warm)) s+=2;
        if(r.title.includes('Ski') && snowish) s+=3;
        if(r.title.includes('Kite') && windy) s+=2;
        return s;
      };

      return recs
        .map(r => ({...r, _score:score(r)}))
        .sort((a,b)=> b._score - a._score)
        .slice(0,6);
    }
    const LEGACY_RESPONSE_KEYS = {
      temperature: String.fromCharCode(116,101,109,112,101,114,97,116,117,114,97),
      rain: String.fromCharCode(108,108,117,118,105,97),
      wind: String.fromCharCode(118,105,101,110,116,111),
      radiation: String.fromCharCode(114,97,100,105,97,99,105,111,110)
    };

    function pick(obj, ...keys){
      if(!obj || typeof obj !== 'object') return null;
      for(const key of keys){
        if(Object.prototype.hasOwnProperty.call(obj, key) && obj[key] !== null && obj[key] !== undefined){
          return obj[key];
        }
      }
      return null;
    }

    function normalizeForecastResponse(raw){
      return {
        temperature: asNumber(pick(raw, 'temperature', 'temp', 'tempC', LEGACY_RESPONSE_KEYS.temperature)),
        rain: asNumber(pick(raw, 'rain', 'precip', 'precipitation', LEGACY_RESPONSE_KEYS.rain)),
        wind: asNumber(pick(raw, 'wind', 'windSpeed', 'wind_speed', LEGACY_RESPONSE_KEYS.wind)),
        radiation: asNumber(pick(raw, 'radiation', 'solarRadiation', 'solar_radiation', LEGACY_RESPONSE_KEYS.radiation))
      };
    }

    function updateRecommendationsFromData(data, lat, dateISO){
      const recs = buildRecommendations({
        lat,
        dateISO,
        temperature: data.temperature,
        rain: data.rain,
        windSpeed: data.wind,
        radiation: data.radiation
      });
      renderRecs(recs);
    }

    function formatNumber(value, decimals = 2){
      const n = asNumber(value);
      if(n === null) return null;
      return n.toFixed(decimals);
    }

    function formatValueWithUnit(value, unit){
      const formatted = formatNumber(value);
      return formatted === null ? null : `${formatted} ${unit}`;
    }

    function describeTemperature(value){
      const v = asNumber(value);
      if(v === null) return 'No data';
      if(v >= 32) return 'Very hot';
      if(v >= 28) return 'Hotter';
      if(v >= 22) return 'Warm';
      if(v >= 16) return 'Mild';
      if(v >= 8) return 'Cool';
      if(v >= 0) return 'Cold';
      return 'Freezing';
    }

    function describeRain(value){
      const v = asNumber(value);
      if(v === null) return 'No data';
      if(v === 0) return 'Dry';
      if(v < 2) return 'Drizzly';
      if(v < 6) return 'Rainy';
      if(v < 12) return 'Showery';
      return 'Stormy';
    }

    function describeWind(value){
      const v = asNumber(value);
      if(v === null) return 'No data';
      if(v >= 14) return 'Very windy';
      if(v >= 8) return 'Windy';
      if(v >= 3) return 'Breezy';
      if(v >= 1) return 'Light breeze';
      if(v > 0) return 'Calm';
      return 'Calm';
    }

    function describeRadiation(value){
      const v = asNumber(value);
      if(v === null) return 'No data';
      if(v >= 800) return 'High UV, seek shade';
      if(v >= 600) return 'Use sunscreen';
      if(v >= 350) return 'Go out with hat';
      if(v >= 150) return 'Soft sunlight';
      return 'Low light';
    }

    function formatMetricLine({ emoji, label, descriptor, valueText }){
      if(!descriptor || descriptor === 'No data'){
        return `${emoji} ${label}: ${descriptor || 'No data'}`;
      }
      return `${emoji} ${label}: ${descriptor}${valueText ? ` (${valueText})` : ''}`;
    }

    function buildSummaryHTML({ introText = 'Conditions snapshot for this area', coordsText, data }){
      const lines = [
        `üìç Coordinates: ${coordsText}`,
        formatMetricLine({
          emoji:'üå°Ô∏è',
          label:'Temperature',
          descriptor: describeTemperature(data.temperature),
          valueText: formatValueWithUnit(data.temperature, '¬∞C')
        }),
        formatMetricLine({
          emoji:'‚òî',
          label:'Rain',
          descriptor: describeRain(data.rain),
          valueText: formatValueWithUnit(data.rain, 'mm')
        }),
        formatMetricLine({
          emoji:'üå¨Ô∏è',
          label:'Wind',
          descriptor: describeWind(data.wind),
          valueText: formatValueWithUnit(data.wind, 'm/s')
        }),
        formatMetricLine({
          emoji:'‚òÄÔ∏è',
          label:'Solar radiation',
          descriptor: describeRadiation(data.radiation),
          valueText: formatValueWithUnit(data.radiation, 'W/m¬≤')
        })
      ].filter(Boolean);

      return `
        <div class="summary-brief">${introText}</div>
        <ol class="summary-breakdown">
          ${lines.map(line => `<li>${line}</li>`).join('')}
        </ol>
      `.trim();
    }

    /* =================== STATUS CARD =================== */
    function updateStatusCard(data){
      const statusCard = document.getElementById('statusCard');
      const statusTitle = document.getElementById('statusTitle');
      const statusText = document.getElementById('statusText');

      const T = nz(data.temperature);
      const P = nz(data.rain);
      const W = nz(data.wind);
      const R = nz(data.radiation);

      let title = '', text = '', tone = 'neutral';

      // Weather analysis
      const heavyRain = P >= 10;
      const rainMod = P >= 2 && P < 10;
      const lightRain = P > 0 && P < 2;
      const hot = T >= 26;
      const warm = T >= 18 && T < 26;
      const cool = T >= 10 && T < 18;
      const cold = T < 10;
      const windy = W >= 8;
      const highRad = R >= 650;

      // Determine the main message
      if(heavyRain){
        title = '‚òî Rainy day';
        text = `Expect heavy rain (${P.toFixed(1)} mm). Bring an umbrella and avoid outdoor plans.`;
        tone = 'rainy';
      } else if(rainMod){
        title = 'üåßÔ∏è Moderate rain';
        text = `Likely showers (${P.toFixed(1)} mm). Consider indoor activities or bring rain gear.`;
        tone = 'rainy';
      } else if(lightRain){
        title = 'üå¶Ô∏è Light showers';
        text = `Possible drizzle (${P.toFixed(1)} mm). Weather is mostly clear otherwise.`;
        tone = 'neutral';
      } else if(hot && highRad){
        title = '‚òÄÔ∏è Hot and sunny';
        text = `High temperature (${T.toFixed(1)}¬∞C) with strong sun (${R.toFixed(0)} W/m¬≤). Use sunscreen and stay hydrated.`;
        tone = 'sunny';
      } else if(hot){
        title = 'üå°Ô∏è Very hot';
        text = `It will be hot (${T.toFixed(1)}¬∞C). Look for shade and drink plenty of water.`;
        tone = 'hot';
      } else if(cold && windy){
        title = '‚ùÑÔ∏è Cold and windy';
        text = `Low temperature (${T.toFixed(1)}¬∞C) with strong wind (${W.toFixed(1)} m/s). Bundle up.`;
        tone = 'cold';
      } else if(cold){
        title = 'üßä Cold day';
        text = `Cold temperature (${T.toFixed(1)}¬∞C). Don‚Äôt forget your coat.`;
        tone = 'cold';
      } else if(windy){
        title = 'üí® Very windy';
        text = `Strong winds (${W.toFixed(1)} m/s). Secure loose items.`;
        tone = 'windy';
      } else if(warm && highRad){
        title = 'üå§Ô∏è Pleasant and sunny';
        text = `Comfortable temperature (${T.toFixed(1)}¬∞C) with sunshine. Great for outdoor plans.`;
        tone = 'sunny';
      } else if(warm){
        title = 'üòä Comfortable weather';
        text = `Nice temperature (${T.toFixed(1)}¬∞C). Perfect for going out.`;
        tone = 'sunny';
      } else if(cool){
        title = 'üçÇ Cool day';
        text = `Cool temperature (${T.toFixed(1)}¬∞C). Grab a light jacket.`;
        tone = 'neutral';
      } else {
        title = 'üåç Stable weather';
        text = `Typical conditions. Temperature: ${T.toFixed(1)}¬∞C.`;
        tone = 'neutral';
      }

      if(statusTitle) statusTitle.textContent = title;
      if(statusText) statusText.textContent = text;
      if(statusCard){
        statusCard.setAttribute('data-tone', tone);
        // Show the card when data is available
        statusCard.style.display = 'flex';
      }

      return { title, text, tone };
    }
    /* =================== END STATUS CARD =================== */

    /* =================== END RECOMMENDATIONS =================== */

  // --------- Base layers with controlled auto-switch ----------
    const esriLayerUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    const ESRI_MAX_NATIVE = 18;

    function makeOSM(){
      return L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19, noWrap:true, bounds:WORLD_BOUNDS, attribution:'&copy; OpenStreetMap'
      });
    }
    function makeEsri(){
      return L.tileLayer(esriLayerUrl,{
        noWrap:true, bounds:WORLD_BOUNDS, attribution:'&copy; Esri',
        maxNativeZoom: ESRI_MAX_NATIVE,
        maxZoom: 19
      });
    }

    let baseLayer = null;
    let baseName  = null;
    let autoDemotedFromEsri = false;

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> t.classList.remove('show'), 2200);
    }

    function switchToOSM(showMsg=true, opts={}) {
      const auto = !!opts.auto;
      if (baseLayer) baseLayer.remove();
    baseLayer = makeOSM().addTo(map);
    baseName = 'osm';
    autoDemotedFromEsri = auto;
    if (showMsg) showToast(auto ? 'Switched to OSM (World Imagery limit).' : 'OSM active.');
      repositionZoom();
    }

    function switchToEsri(showMsg=true, opts={}) {
      if (baseLayer) baseLayer.remove();
    baseLayer = makeEsri().addTo(map);
    baseName = 'esri';
    autoDemotedFromEsri = false;
    if (showMsg) showToast('World Imagery active.');

      let errorCount = 0;
      const onTileError = () => {
        errorCount++;
        if (errorCount >= 4) {
          switchToOSM(false, {auto:true});
          showToast('Switched to OSM: no more World Imagery tiles at this zoom level.');
        }
      };
      const resetErrors = () => { errorCount = 0; };
      baseLayer.on('tileerror', onTileError);
      baseLayer.on('load', resetErrors);

      repositionZoom();
    }

    // --- Data modal ---
    const dataModalOverlay = document.getElementById('dataModalOverlay');
    const dataModalClose = document.getElementById('dataModalClose');
    const dataModalAck = document.getElementById('dataModalAck');

    const onModalKeyDown = (event) => {
      if (event.key === 'Escape') hideDataModal();
    };

    function showDataModal(){
      if(!dataModalOverlay) return;
      dataModalOverlay.classList.add('show');
      document.body.dataset.modalOpen = 'true';
      document.body.style.overflow = 'hidden';
      document.addEventListener('keydown', onModalKeyDown);
    }

    function hideDataModal(){
      if(!dataModalOverlay) return;
      dataModalOverlay.classList.remove('show');
      delete document.body.dataset.modalOpen;
      document.body.style.overflow = '';
      document.removeEventListener('keydown', onModalKeyDown);
    }

    dataModalClose?.addEventListener('click', hideDataModal);
    dataModalAck?.addEventListener('click', hideDataModal);
    dataModalOverlay?.addEventListener('click', (event) => {
      if (event.target === dataModalOverlay) hideDataModal();
    });

    // Initial state: World Imagery
    switchToEsri(false);

    // Base map buttons
    document.getElementById('btnMapOSM').onclick  = () => switchToOSM(true, {auto:false});
    document.getElementById('btnMapEsri').onclick = () => switchToEsri(true, {auto:false});

    // Auto-switch based on zoom:
    map.on('zoomend', () => {
      const z = map.getZoom();
      if (baseName === 'esri' && z > ESRI_MAX_NATIVE) {
        switchToOSM(false, {auto:true});
        showToast('Max zoom reached for World Imagery. Switched to OSM automatically.');
      } else if (baseName === 'osm' && autoDemotedFromEsri && z <= ESRI_MAX_NATIVE) {
        switchToEsri(false, {auto:true});
        showToast('Back to World Imagery (zoom within range).');
      }
    });

    // Visual adjustment on load
    window.addEventListener('load', () => {
      setTimeout(()=> {
        map.invalidateSize();
        repositionZoom();
      }, 50);
      setTimeout(()=>{ showDataModal(); }, 150);
    });

    // --- Marker and zone ---
    let centerMarker=null; let zoneCircle=null; let selectedLat=null, selectedLon=null;
    function setZone(lat,lon){
      selectedLat=Number(lat).toFixed(5); selectedLon=Number(lon).toFixed(5);
      const rkm=Number(radiusKm.value); const rMeters=rkm*1000;
      if(centerMarker) map.removeLayer(centerMarker);
      centerMarker=L.marker([selectedLat,selectedLon]).addTo(map);
      if(!zoneCircle){
        zoneCircle=L.circle([selectedLat,selectedLon],{radius:rMeters,color:'#2563eb',fillColor:'#93c5fd',fillOpacity:0.15,weight:2}).addTo(map);
      } else {
        zoneCircle.setLatLng([selectedLat,selectedLon]).setRadius(rMeters);
      }
      map.fitBounds(zoneCircle.getBounds(),{padding:[40,40]});
    zoneHint.textContent=`Zone centered at ${selectedLat}, ${selectedLon} with a ${rkm} km radius.`;
    }
    map.on('click',(e)=>setZone(e.latlng.lat,e.latlng.lng));

    /************ Move zoom controls below the search dock ************/
    function repositionZoom(){
      const mapEl   = document.getElementById('map');
      const corner  = mapEl.querySelector('.leaflet-top.leaflet-left');
      const dock    = document.getElementById('searchDock');
      if (!corner || !dock) return;
      const dockRect = dock.getBoundingClientRect();
      const mapRect  = mapEl.getBoundingClientRect();
      const GAP = 8;
      let offset = Math.max(GAP, (dockRect.bottom - mapRect.top) + GAP);
      corner.style.top = offset + 'px';
    }
    window.addEventListener('resize', repositionZoom);

    /************ UI ************/
    const radiusKm=document.getElementById('radiusKm');
    const radiusLabel=document.getElementById('radiusLabel');
    const weeksSel=document.getElementById('weeks');
    const startDate=document.getElementById('startDate');
  const btnForecast=document.getElementById('btnForecast');
  const statusSummaryBody=document.getElementById('statusSummaryBody');
  const zoneHint=document.getElementById('zoneHint');
  const sidebar=document.getElementById('sidebar');
    radiusLabel.textContent=radiusKm.value;

    // Calendar: today -> +365 days
    function toISO(d){return new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())).toISOString().slice(0,10);}
    const today=new Date();
    const todayISO=toISO(today);
    const maxISO=toISO(new Date(today.getFullYear(), today.getMonth(), today.getDate()+365));
    startDate.min=todayISO; startDate.max=maxISO; startDate.value=todayISO;

    radiusKm.addEventListener('input',()=>{
      radiusLabel.textContent=radiusKm.value;
      if(selectedLat&&selectedLon&&zoneCircle) zoneCircle.setRadius(Number(radiusKm.value)*1000);
    });

    const LEGACY_REQUEST_KEYS = {
      date: String.fromCharCode(102,101,99,104,97),
      radius: String.fromCharCode(114,97,100,105,111)
    };

    /* ============= FINAL HANDLER: SUMMARY + RECS ============= */
    btnForecast.addEventListener('click', async ()=>{
      if(!selectedLat || !selectedLon){
        showToast('Select a point on the map first.');
        return;
      }

      const latNum = parseFloat(selectedLat);
      const lonNum = parseFloat(selectedLon);
      const dateISO = startDate?.value || new Date().toISOString().slice(0,10);

      const statusCard = document.getElementById('statusCard');
      if(statusCard){
        statusCard.style.display = 'flex';
        statusCard.classList.add('loading');
      }

      if(statusSummaryBody){
        statusSummaryBody.classList.add('muted');
        statusSummaryBody.innerHTML = '<div class="status-summary-message"><em>Loading forecast...</em></div>';
      }

      document.getElementById('recs').innerHTML = `<div class="muted">Calculating recommendations‚Ä¶</div>`;

      try {
        const payload = {
          lat: latNum,
          lon: lonNum,
          date: dateISO,
          radius: Number(radiusKm.value) || 15
        };
        payload[LEGACY_REQUEST_KEYS.date] = dateISO;
        payload[LEGACY_REQUEST_KEYS.radius] = payload.radius;

        const res = await fetch(BASE_URL + '/predict', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();

        const normalized = normalizeForecastResponse(data);

        const statusInfo = updateStatusCard(normalized);
        if(statusCard) statusCard.classList.remove('loading');
        const coordsText = `${selectedLat}, ${selectedLon}`;
        const summaryIntro = `Key metrics for the selected zone (starting ${dateISO})`;

        if(statusSummaryBody){
          statusSummaryBody.classList.remove('muted');
          statusSummaryBody.innerHTML = buildSummaryHTML({
          introText: summaryIntro,
          coordsText,
          data: normalized
          });
        }

        // Recommendations
        updateRecommendationsFromData(normalized, latNum, dateISO);

      } catch (err) {
        console.error(err);
        if(statusCard) statusCard.classList.remove('loading');
        if(statusSummaryBody){
          statusSummaryBody.classList.add('muted');
          statusSummaryBody.innerHTML = '<div class="status-summary-message">‚ùå Unable to retrieve the forecast.</div>';
        }
        document.getElementById('recs').innerHTML = `<div class="muted">Recommendations could not be calculated.</div>`;
        // Reset the status card in case of error
        const statusCard = document.getElementById('statusCard');
        const statusTitle = document.getElementById('statusTitle');
        const statusText = document.getElementById('statusText');
        if(statusCard && statusTitle && statusText){
          statusTitle.textContent = '‚ö†Ô∏è Error loading data';
          statusText.textContent = 'Forecast data could not be retrieved.';
          statusCard.setAttribute('data-tone', 'alert');
          statusCard.style.display = 'flex';
        }
      }
  });
  /* ======================== END FINAL HANDLER ======================== */

  /************ SEARCH ************/
    const searchDock = document.getElementById('searchDock');
    const searchInput = document.getElementById('searchInput');
    const searchGo = document.getElementById('searchGo');

    function parseLatLon(str){
      const m = str.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
      if(!m) return null;
      const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
      if(lat<-90||lat>90||lon<-180||lon>180) return null;
      return {lat, lon};
    }

    async function geocodeNominatim(q){
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1&addressdetails=1&accept-language=en`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if(!res.ok) return null;
      const arr = await res.json();
      if(!Array.isArray(arr) || !arr.length) return null;
      return { lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon), label: arr[0].display_name };
    }

    async function geocodePhoton(q){
      const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(q)}&limit=1&lang=en`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if(!res.ok) return null;
      const json = await res.json();
      const feat = json && json.features && json.features[0];
      if(!feat) return null;
      const [lon, lat] = feat.geometry.coordinates;
      const label = feat.properties && (feat.properties.name || feat.properties.country || 'Result');
      return { lat: parseFloat(lat), lon: parseFloat(lon), label };
    }

    async function runSearch(){
      const q = searchInput.value.trim();
      if(!q) return;

      searchDock.classList.remove('error');
      searchDock.classList.add('busy');
      searchGo.disabled = true;

      try {
        const coords = parseLatLon(q);
        if (coords){
          map.setView([coords.lat, coords.lon], 10);
          setZone(coords.lat, coords.lon);
          return;
        }
        let r = await geocodeNominatim(q);
        if(!r) r = await geocodePhoton(q);

        if(r){
          map.setView([r.lat, r.lon], 10);
          setZone(r.lat, r.lon);
        } else {
          searchDock.classList.add('error');
          alert('Could not find that place üòï Try another search or use the format: lat,lon');
        }
      } catch (e){
        console.error(e);
        searchDock.classList.add('error');
        alert('Search failed. Check your connection and try again.');
      } finally {
        searchDock.classList.remove('busy');
        searchGo.disabled = false;
        repositionZoom();
      }
    }
    searchGo.addEventListener('click', runSearch);
    searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') runSearch(); });

  /************ Toggle panel ************/
    const toggleBtn = document.getElementById('toggleSidebar');
    toggleBtn.addEventListener('click', ()=>{
      const collapsed = sidebar.classList.toggle('collapsed');
      toggleBtn.textContent = collapsed ? '¬ª' : '¬´';
  toggleBtn.title = collapsed ? 'Show panel' : 'Hide panel';
      toggleBtn.setAttribute('aria-label', toggleBtn.title);
      setTimeout(()=> {
        map.invalidateSize();
        repositionZoom();
      }, 260);
    });

  /************ Basic chatbot ************/
    const btn=document.getElementById('chatbot-btn');
    const win=document.getElementById('chatbot-window');
    const close=document.getElementById('chatbot-close');
    const send=document.getElementById('chatbot-send');
    const input=document.getElementById('chatbot-text');
    const body=document.getElementById('chatbot-body');

    btn.addEventListener('click',()=>{win.style.display=win.style.display==='flex'?'none':'flex';});
    close.addEventListener('click',()=>{win.style.display='none';});
    send.addEventListener('click',sendMsg);
    input.addEventListener('keydown',(e)=>{if(e.key==='Enter')sendMsg();});
    async function sendMsg() {
      const txt = input.value.trim();
      if (!txt) return;
  body.innerHTML += `<p><strong>You:</strong> ${txt}</p>`;
      input.value = '';
      body.scrollTop = body.scrollHeight;
      try {
        const res = await fetch(BASE_URL + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: txt })
        });
        const data = await res.json();
        body.innerHTML += `<p><strong>Bot:</strong> ${data.reply}</p>`;
      } catch (err) {
  body.innerHTML += `<p><strong>Bot:</strong> Could not reach the server üò¢</p>`;
      }
      body.scrollTop = body.scrollHeight;
    }
  </script>
</body>
</html>


